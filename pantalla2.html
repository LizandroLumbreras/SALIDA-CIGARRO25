<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Salida de Productos â€“ Cigarro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      margin:0;padding:0;color:white;
      min-height:100vh;position:relative;
    }
    .marca-agua{
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%);
      opacity:.1;z-index:0;max-width:80%;
      pointer-events:none;
    }
    .contenedor{
      max-width:650px;margin:50px auto;padding:20px;
      background:rgba(255,255,255,0.1);border-radius:12px;
      position:relative;z-index:2;
    }
    h2{text-align:center;margin-bottom:20px;}
    .tarjeta,.producto{
      background:white;color:black;padding:14px 18px;
      margin:10px 0;border-radius:10px;font-weight:600;
      cursor:pointer;text-align:center;
      transition:background .25s;
    }
    .tarjeta:hover,.producto:hover{background:#e3f2fd;}
    #popupCantidad{
      display:none;position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%);background:white;padding:22px;
      border-radius:10px;z-index:9999;color:black;width:90%;
      max-width:350px;box-shadow:0 4px 12px rgba(0,0,0,.25);
    }
    #popupCantidad input{
      width:100%;padding:10px;margin:10px 0;font-size:16px;
    }
    #popupCantidad button{
      padding:10px 20px;margin:5px;border:none;border-radius:6px;
      cursor:pointer;font-weight:bold;
    }
    .cancelar{background:#ccc;color:black;}
    .agregar{background:#00416A;color:white;}
</style>
</head>

<body>

<img src="logo_proveedora.webp" class="marca-agua">

<div class="contenedor" id="pantalla">
    <h2>Selecciona Marca</h2>

    <button id="btnActualizar"
      style="display:block;margin:10px auto;background:#0d47a1;color:white;
      border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">
      ðŸ”„ Actualizar productos
    </button>

    <div id="marcasContainer"></div>
    <p id="loader" style="text-align:center;margin-top:20px;">Cargando marcas...</p>
</div>

<div class="contenedor" id="productos" style="display:none;">
    <h2 id="tituloProductos"></h2>
    <div id="listaProductos"></div>
</div>

<div id="popupCantidad">
    <h3>Agregar cantidad</h3>
    <p id="nombreProductoSeleccionado"></p>
    <input type="number" id="inputCantidad" placeholder="Cantidad" min="0.001" step="0.001">
    <div style="text-align:right;">
      <button class="cancelar" onclick="cerrarPopup()">Cancelar</button>
      <button class="agregar" onclick="confirmarCantidad()">Agregar</button>
    </div>
</div>

<script type="module">
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let productos = [];
let marcasUnicas = new Set();

// =======================================================
//  CARGAR PRODUCTOS ACTIVOS DEL DEPARTAMENTO "CIGARROS"
// =======================================================
async function cargarProductos() {
    document.getElementById("loader").style.display = "block";
    productos = [];
    marcasUnicas.clear();

    const colRef = collection(db, "productos");
    const snap = await getDocs(colRef);

    snap.forEach(doc => {
        const d = doc.data();

        if (d.activo !== true) return;                       // solo activos
        if (d.departamento !== "CIGARROS") return;          // solo cigarros

        const marca = (d.marca || "SIN MARCA").trim().toUpperCase();
        const codigo = (d.codigoBarra || doc.id).trim();
        const descripcion = (d.concepto || d.descripcion || "").trim();

        if (!codigo || !descripcion) return;

        productos.push({
            codigo,
            descripcion,
            marca
        });

        marcasUnicas.add(marca);
    });

    document.getElementById("loader").style.display = "none";
    mostrarMarcas();
}

// =======================================================
//           MOSTRAR TARJETAS POR MARCA
// =======================================================
function mostrarMarcas() {
    const cont = document.getElementById("marcasContainer");
    cont.innerHTML = "";

    [...marcasUnicas].sort().forEach(marca => {
        const div = document.createElement("div");
        div.className = "tarjeta";
        div.textContent = marca;
        div.onclick = () => mostrarProductos(marca);
        cont.appendChild(div);
    });
}

// =======================================================
//        MOSTRAR PRODUCTOS DE ESA MARCA
// =======================================================
function mostrarProductos(marca) {
    document.getElementById("pantalla").style.display = "none";

    const lista = document.getElementById("listaProductos");
    lista.innerHTML = "";

    const filtrados = productos.filter(p => p.marca === marca);

    filtrados.sort((a,b)=>a.descripcion.localeCompare(b.descripcion));

    filtrados.forEach(p => {
        const div = document.createElement("div");
        div.className = "producto";
        div.textContent = p.descripcion;
        div.onclick = () => abrirPopup(p);
        lista.appendChild(div);
    });

    document.getElementById("tituloProductos").textContent = marca;
    document.getElementById("productos").style.display = "block";
}

// =======================================================
//          POPUP MANEJO CANTIDAD
// =======================================================
let productoSeleccionado = null;

function abrirPopup(p) {
    productoSeleccionado = p;
    document.getElementById("nombreProductoSeleccionado").textContent = p.descripcion;
    document.getElementById("inputCantidad").value = "";
    document.getElementById("popupCantidad").style.display = "block";
}

window.cerrarPopup = function () {
    document.getElementById("popupCantidad").style.display = "none";
};

window.confirmarCantidad = function () {
    const cantidad = parseFloat(document.getElementById("inputCantidad").value);

    if (!cantidad || cantidad <= 0) {
        alert("Cantidad invÃ¡lida");
        return;
    }

    let carrito = JSON.parse(localStorage.getItem("carrito_cigarro") || "[]");

    carrito.push({
        nombre: productoSeleccionado.descripcion,
        codigo: productoSeleccionado.codigo,
        cantidad
    });

    localStorage.setItem("carrito_cigarro", JSON.stringify(carrito));
    cerrarPopup();
    window.location.href = "pantalla3.html";
};

// =======================================================
//  EVENTO ACTUALIZAR
// =======================================================
document.getElementById("btnActualizar").onclick = () => cargarProductos();

// Inicio
cargarProductos();

</script>

</body>
</html>

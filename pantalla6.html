<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen de salida - Cigarro</title>
  <style>
    :root{--ticket-width-mm:80;--ticket-margin-mm:5}
    body{font-family:Arial,sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);color:black;padding:20px;box-sizing:border-box;min-height:100vh}
    .contenedor{background:white;border-radius:10px;padding:16px 14px;max-width:820px;margin:auto;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .header{text-align:center;margin-bottom:8px}
    .logo{display:block;margin:0 auto 6px;width:220px;max-width:90%}
    .titulo{margin:2px 0 8px 0;color:#00416A;font-size:20px;font-weight:700;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px 4px;text-align:center}
    th{background:#00416A;color:white}
    .firmas{display:flex;justify-content:space-around;margin-top:18px;gap:10px;flex-wrap:wrap}
    .firma-box{text-align:center}
    .firma-box img{width:180px;height:auto;border:1px solid #ccc;background:#fff}
    .btn-imprimir{display:block;margin:18px auto 0;padding:12px 20px;background:#0c6cbd;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    .btn-imprimir[disabled]{opacity:.6;cursor:not-allowed}
    .btn-imprimir:hover{background:#094a85}
    @media print{.btn-imprimir{display:none}}
  </style>
</head>
<body>
  <div class="contenedor" id="resumenSalida">
    <div class="header">
      <img id="logoEmpresa" class="logo" src="logo_proveedora.webp" alt="Logo La Proveedora" crossOrigin="anonymous">
      <div class="titulo">Resumen de Salida - Almacén Cigarro</div>
    </div>

    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead><tr><th>Código</th><th>Descripción</th><th>Unidad</th><th>Cantidad</th></tr></thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box"><p>Firma entrega</p><img id="imgFirmaEntrega" alt="Firma entrega" crossOrigin="anonymous"></div>
      <div class="firma-box"><p>Firma recibe</p><img id="imgFirmaRecibe"  alt="Firma recibe"  crossOrigin="anonymous"></div>
    </div>
  </div>

  <button class="btn-imprimir" id="btnGuardarDescargar">Guardar y descargar PDF</button>

  <!-- Firebase + libs (compat v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ==== Firebase ====
    const firebaseConfig={
      apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain:"inventariopv-643f1.firebaseapp.com",
      projectId:"inventariopv-643f1",
      storageBucket:"inventariopv-643f1.appspot.com",
      messagingSenderId:"96242533231",
      appId:"1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    // ==== Carga de datos locales ====
    const datos = JSON.parse(localStorage.getItem('salidaCigarro')||'{}');
    const productos = JSON.parse(localStorage.getItem('carrito_cigarro')||'[]');

    function leerFirma(keys){
      for(const k of keys){
        const v=localStorage.getItem(k);
        if(v && v.startsWith('data:image')) return v;
      }
      return '';
    }
    const firmaEntregaB64 = leerFirma(['firma_entrega_cigarro','firmaEntrega']);
    const firmaRecibeB64  = leerFirma(['firma_recibe_cigarro','firmaRecibe']);

    const $folio = document.getElementById('folio');
    const $fecha = document.getElementById('fecha');
    const $entrega = document.getElementById('entrega');
    const $recibe = document.getElementById('recibe');
    const $destino = document.getElementById('destino');
    const $imgFirmaEntrega = document.getElementById('imgFirmaEntrega');
    const $imgFirmaRecibe  = document.getElementById('imgFirmaRecibe');

    $fecha.textContent   = datos.fecha || new Date().toLocaleString('es-MX');
    $entrega.textContent = datos.entrega || '';
    $recibe.textContent  = datos.recibe || '';
    $destino.textContent = datos.destino || '';
    $imgFirmaEntrega.src = firmaEntregaB64 || '';
    $imgFirmaRecibe.src  = firmaRecibeB64  || '';

    const tbody=document.getElementById('tabla-productos');
    (productos||[]).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.codigo??''}</td>
        <td>${p.descripcion??''}</td>
        <td>${p.unidad??''}</td>
        <td>${p.cantidad??0}</td>`;
      tbody.appendChild(tr);
    });

    // ==== Generar folio con transacción (siempre) ====
    const CONSEC_COL = 'consecutivos';
    const CONSEC_DOC = 'salidas_cigarro'; // ← ajusta si tu doc se llama diferente
    const pad = n => String(n).padStart(4,'0');

    async function getNextFolio(){
      const ref = db.collection(CONSEC_COL).doc(CONSEC_DOC);
      const numero = await db.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        const cur  = snap.exists ? Number(snap.data().ultimo || 0) : 0;
        const next = cur + 1;
        if (snap.exists) { tx.update(ref, { ultimo: next }); }
        else { tx.set(ref, { ultimo: next }); }
        return next;
      });
      return `SAL-CIG-${pad(numero)}`;
    }

    // ==== Guardar salida en Firestore (con folio asegurado) ====
    async function guardarSalidaConFolio(){
      // SIEMPRE genera folio nuevo (no reutiliza localStorage)
      const folioFinal = await getNextFolio();
      $folio.textContent = folioFinal;

      const data = {
        folio: folioFinal,
        fecha: $fecha.textContent || new Date().toLocaleString('es-MX'),
        entrega: datos.entrega || '',
        recibe:  datos.recibe  || '',
        destino: datos.destino || '',
        productos: productos || [],
        firmaEntrega: firmaEntregaB64 || '',
        firmaRecibe:  firmaRecibeB64  || '',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection('almacenes')
        .doc('almacen_cigarro')
        .collection('salidas')
        .add(data);

      // Limpia el folio de localStorage para el siguiente flujo
      try {
        const tmp = JSON.parse(localStorage.getItem('salidaCigarro') || '{}');
        delete tmp.folio;
        localStorage.setItem('salidaCigarro', JSON.stringify(tmp));
      } catch(_) {}

      return folioFinal;
    }

    // ==== Utilidades PDF ====
    function preloadImageEl(imgEl){
      return new Promise(res=>{
        if(!imgEl) return res();
        if(imgEl.complete) return res();
        imgEl.onload = ()=>res();
        imgEl.onerror= ()=>res();
      });
    }

    async function descargarPDF_robusto(){
      const { jsPDF } = window.jspdf;
      const resumen = document.getElementById('resumenSalida');

      await Promise.all([
        preloadImageEl(document.getElementById('logoEmpresa')),
        preloadImageEl($imgFirmaEntrega),
        preloadImageEl($imgFirmaRecibe)
      ]);

      const W = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-width-mm')) || 80;
      const M = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-margin-mm')) || 5;

      try{
        const canvas = await html2canvas(resumen, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
        const img = canvas.toDataURL('image/png');
        const pxW = canvas.width, pxH = canvas.height;
        const usable = W - (M*2);
        const pxPerMM = pxW / usable;
        const H = (pxH / pxPerMM) + (M*2);

        const pdf = new jsPDF('p','mm',[W,H]);
        pdf.addImage(img,'PNG',M,M,usable,pxH/pxPerMM);

        const nombre = `Comprobante_${($folio.textContent||'SAL-CIG').replace(/\s+/g,'_')}.pdf`;
        pdf.save(nombre);
      }catch(err){
        console.error('Fallo html2canvas; fallback simple:', err);
        const pdf = new jsPDF('p','mm',[W,297]);
        let y = 10;
        pdf.setFontSize(12);
        pdf.text('La Proveedora de Dulces y Desechables', 10, y); y+=8;
        pdf.setFontSize(10);
        pdf.text('Resumen de Salida - Almacén Cigarro', 10, y); y+=6;
        pdf.text(`Folio: ${$folio.textContent||''}`, 10, y); y+=6;
        pdf.text(`Fecha: ${$fecha.textContent||''}`, 10, y); y+=6;
        pdf.text(`Entrega: ${$entrega.textContent||''}`, 10, y); y+=6;
        pdf.text(`Recibe: ${$recibe.textContent||''}`, 10, y); y+=6;
        pdf.text(`Destino: ${$destino.textContent||''}`, 10, y); y+=8;
        pdf.text('Productos:', 10, y); y+=6;
        (productos||[]).forEach(p=>{
          const line = `${p.codigo??''} | ${p.descripcion??''} | ${p.unidad??''} | Cant: ${p.cantidad??0}`;
          pdf.text(line.substring(0,100), 10, y); y+=5;
          if(y>280){ pdf.addPage(); y=10; }
        });
        const nombre = `Comprobante_${($folio.textContent||'SAL-CIG').replace(/\s+/g,'_')}.pdf`;
        pdf.save(nombre);
      }
    }

    // ==== Flujo completo (con anti doble-click) ====
    const btn = document.getElementById('btnGuardarDescargar');

    async function guardarYDescargar(){
      if(!productos || productos.length===0){
        alert("No hay productos en el resumen.");
        return;
      }
      btn.disabled = true;
      try{
        await guardarSalidaConFolio();
        await descargarPDF_robusto();

        // Limpieza y regreso
        setTimeout(()=>{
          localStorage.removeItem('carrito_cigarro');
          // localStorage.removeItem('firma_entrega_cigarro');
          // localStorage.removeItem('firma_recibe_cigarro');
          window.location.href='index.html';
        }, 1200);
      }catch(e){
        console.error(e);
        alert("Error al guardar o descargar: "+(e.message||e));
      }finally{
        btn.disabled = false; // por si no redirige
      }
    }

    btn.addEventListener('click', guardarYDescargar);
  </script>
</body>
</html>

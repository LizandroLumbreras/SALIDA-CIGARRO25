<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen de salida - Cigarro</title>
  <style>
    :root{--ticket-width-mm:80;--ticket-margin-mm:5}
    body{font-family:Arial,sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);color:black;padding:20px;box-sizing:border-box;min-height:100vh}
    .contenedor{background:white;border-radius:10px;padding:16px 14px;max-width:820px;margin:auto;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .header{text-align:center;margin-bottom:8px}
    .logo{display:block;margin:0 auto 6px;width:220px;max-width:90%;image-rendering:-webkit-optimize-contrast;filter:grayscale(0)}
    .titulo{margin:2px 0 8px 0;color:#00416A;font-size:20px;font-weight:700;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px 4px;text-align:center}
    th{background:#00416A;color:white}
    .firmas{display:flex;justify-content:space-around;margin-top:18px;gap:10px;flex-wrap:wrap}
    .firma-box{text-align:center}
    .firma-box img{width:180px;height:auto;border:1px solid #ccc}
    .btn-imprimir{display:block;margin:18px auto 0;padding:12px 20px;background:#0c6cbd;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    .btn-imprimir:hover{background:#094a85}
    @media print{.btn-imprimir{display:none}}
  </style>
</head>
<body>
  <div class="contenedor" id="resumenSalida">
    <div class="header">
      <img id="logoEmpresa" class="logo" src="logo_proveedora.webp" alt="Logo La Proveedora" crossOrigin="anonymous">
      <div class="titulo">Resumen de Salida - Almacén Cigarro</div>
    </div>

    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead><tr><th>Código</th><th>Descripción</th><th>Unidad</th><th>Cantidad</th></tr></thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box"><p>Firma entrega</p><img id="firmaEntrega" alt="Firma entrega"></div>
      <div class="firma-box"><p>Firma recibe</p><img id="firmaRecibe" alt="Firma recibe"></div>
    </div>
  </div>

  <button class="btn-imprimir" id="btnGuardarDescargar">Guardar y descargar PDF</button>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const firebaseConfig={apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",authDomain:"inventariopv-643f1.firebaseapp.com",projectId:"inventariopv-643f1",storageBucket:"inventariopv-643f1.appspot.com",messagingSenderId:"96242533231",appId:"1:96242533231:web:aae75a18fbaf9840529e9a"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const datos=JSON.parse(localStorage.getItem('salidaCigarro')||'{}');
    const productos=JSON.parse(localStorage.getItem('carrito_cigarro')||'[]');

    function leerFirma(keys){for(const k of keys){const v=localStorage.getItem(k);if(v && v.startsWith('data:image')) return v;}return '';}
    const firmaEntrega=leerFirma(['firma_entrega_cigarro','firmaEntrega']);
    const firmaRecibe =leerFirma(['firma_recibe_cigarro','firmaRecibe']);

    folio.textContent   = datos.folio || '';
    fecha.textContent   = datos.fecha || new Date().toLocaleString('es-MX');
    entrega.textContent = datos.entrega || '';
    recibe.textContent  = datos.recibe || '';
    destino.textContent = datos.destino || '';
    document.getElementById('firmaEntrega').src=firmaEntrega;
    document.getElementById('firmaRecibe').src =firmaRecibe;

    const tbody=document.getElementById('tabla-productos');
    productos.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.codigo??''}</td><td>${p.descripcion??''}</td><td>${p.unidad??''}</td><td>${p.cantidad??0}</td>`;
      tbody.appendChild(tr);
    });

    async function guardarSalida(){
      const data={...datos, productos, firmaEntrega, firmaRecibe, timestamp: firebase.firestore.FieldValue.serverTimestamp()};
      await db.collection('almacenes').doc('almacen_cigarro').collection('salidas').add(data);

      // Actualiza consecutivo SAL-CIG
      const cRef=db.collection('consecutivos').doc('salidas_cigarro');
      const s=await cRef.get();
      if(s.exists){ await cRef.update({ultimo:(s.data().ultimo||1)+1}); }
      else{ await cRef.set({ultimo:2}); }
    }

    function preload(img){return new Promise(res=>{if(!img)return res();if(img.complete)return res();img.onload=res;img.onerror=res;});}

    async function descargarPDF(){
      const { jsPDF }=window.jspdf;
      const resumen=document.getElementById('resumenSalida');
      await Promise.all([preload(logoEmpresa),preload(firmaEntrega),preload(firmaRecibe)]);
      const canvas=await html2canvas(resumen,{scale:2,useCORS:true,backgroundColor:'#ffffff'});
      const img=canvas.toDataURL('image/png');

      const W=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-width-mm'))||80;
      const M=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-margin-mm'))||5;

      const pxW=canvas.width, pxH=canvas.height;
      const usable=W-(M*2); const pxPerMM=pxW/usable; const H=pxH/pxPerMM+(M*2);

      const pdf=new jsPDF('p','mm',[W,H]);
      pdf.addImage(img,'PNG',M,M,usable,pxH/pxPerMM);
      const nombre=`Comprobante_${(datos.folio||'SAL-CIG').replace(/\s+/g,'_')}.pdf`;
      pdf.save(nombre);
    }

    async function guardarYDescargar(){
      if(!productos || productos.length===0){alert("No hay productos en el resumen.");return;}
      try{
        await guardarSalida();
        await descargarPDF();
        setTimeout(()=>{ localStorage.removeItem('carrito_cigarro'); window.location.href='index.html'; },1500);
      }catch(e){ alert("Error: "+e.message); }
    }

    document.getElementById('btnGuardarDescargar').addEventListener('click', guardarYDescargar);
  </script>
</body>
</html>
